<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <title>航班信息管理</title>
        <meta content="text/html" charset=utf-8>   
        <link href="/css/bootstrap.css" rel="stylesheet" type="text/css" />
        <link href="/css/manage.css" rel="stylesheet" type="text/css" />
        <link href="/css/style_nomal.css" rel="stylesheet" type="text/css" />
        <link href="/css/tran_history.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="/js/jquery.js"></script>
        <script type="text/javascript" src="/js/bootstrap.js"></script>
        <script type="text/javascript" src="/js/bootstrap-popoverex.js"></script> <!-- test -->
        <!--<script type="text/javascript" src="/js/manage/util.js"></script>-->
    </head>
    <body>
  
%include template/head_bar.inc
        <div class="hero-unit"></div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span2">
                    <div class="well sidebar-nav">
                        <ul class="nav nav-list">
%include template/manage/nav_list.inc active='nlFlight'
                        </ul>
                    </div><!--/.well -->
                </div><!--/span-->

                <div class="span9">
                    <div class="row-fluid"> <!-- search panel -->
                        <div class="seller-search-form" id="basicSearch">
                            <div class="row-fluid"> <!-- search inputs -->
                                <table class="grid-form">
                                    <tr>
                                        <td>
                                                <div>
                                                    <label class="search-label">起飞机场</label>
                                                    <input class="search-input" type="text" id="bsDepartureAirport" placeholder="机场">
                                                </div>
                                        </td>
                                        <td>
                                                <div>
                                                    <label class="search-label">到达机场</label>
                                                    <input class="search-input" type="text" id="bsArrivalAirport" placeholder="机场">
                                                </div>
                                        </td>
                                    </tr>
                                    <!--<tr>
                                        <td>
                                                <div>
                                                    <label class="search-label">起飞时间</label>
                                                    <input class="search-input" type="date" id="bsDepartureTime" placeholder="yyyy/mm/dd">
                                                </div>
                                        </td>
                                        <td>
                                                <div>
                                                    <label class="search-label">到达时间</label>
                                                    <input class="search-input" type="text" id="bsArrivalCity" placeholder="yyyy/mm/dd">
                                                </div>
                                        </td>
                                    </tr>-->
                                    <tr>
                                        <td>
                                                <div>
                                                    <label class="search-label">航班编号</label>
                                                    <input class="search-input" type="text" id="bsFID" placeholder="编号">
                                                </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="row-fluid"> <!-- buttons -->
                                <div class="grid-form" style="text-align:center;">
                                    <button class="btn" style="width:20%" type="button" id="bsSearch">搜索</button>
                                </div>
                            </div>
                        </div> <!-- seller-search-form -->
                    </div> <!-- row-fluid -->
                    <h3 id="resultVerbose">共有0个搜索结果</h3>
                    <div class="row-fluid"> <!-- search result -->
                        <table class="table table-hover" id="resultTable" style="table-layout:fixed">
                            <colgroup>
                                <col width="10%" />
                                <col width="13%" />
                                <col width="13%" />
                                <col width="8%" />
                                <col width="10%" />
                                <col width="13%" />
                                <col width="8%" />
                                <col width="13%" />
                                <col width="11%" />
                            </colgroup>
                            <tr> <!-- header -->
                                <th class="text-cropped">航班编号</th>
                                <th class="text-cropped">起降机场</th>
                                <th class="text-cropped">起降时间</th>
                                <th class="text-cropped">机型</th>
                                <th class="text-cropped">日程</th>
                                <th class="text-cropped">准点率</th>
                                <th class="text-cropped">中转</th>
                                <th class="text-cropped">报价</th>
                            </tr>
                        </table>
                    </div>
                    <div class="row-fluid"> <!-- add result -->
                        <table class="table" id="addTable" style="table-layout:fixed">
                            <colgroup>
                                <col width="10%" />
                                <col width="13%" />
                                <col width="13%" />
                                <col width="8%" />
                                <col width="10%" />
                                <col width="13%" />
                                <col width="8%" />
                                <col width="13%" />
                                <col width="11%" />
                            </colgroup>
                            <tr>
                                <td class="text-cropped">新的航班</td>
                                <td class="cell"><input class="cell-content" id="atID" type="text" placeholder="input"></td>
                                <td class="cell"><input class="cell-content" id="atAirport" type="text" placeholder="input"></td>
                                <td class="cell"><input class="cell-content" id="atTime" type="text" placeholder="input"></td>
                                <td class="cell"><input class="cell-content" id="atAircraftType" type="text" placeholder="input"></td>
                                <td class="cell"><input class="cell-content" id="atSchedule" type="text" placeholder="input"></td>
                                <td class="cell"><input class="cell-content" id="atPunctuality" type="text" placeholder="input"></td>
                                <td class="cell"><input class="cell-content" id="atStop" type="text" placeholder="input"></td>
                                <td>
                                    <div>
                                        <button class="btn btn-icon" id="atAdd"><i class="icon-ok"></i></button>
                                        <button class="btn btn-icon" id="atRemove"><i class="icon-remove"></i></button>
                                        <!--<button class="btn" style="width:10px;float:left;" id="atReset"><i class="icon-repeat"></i></button>-->
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div> <!-- span9 -->
                
            </div> 
        </div>

        <footer class="tail">
            <hr>
            <a href="">关于我们</a>
            <a href="">合作伙伴</a>
            <a href="">联系客服</a>
            <a href="../other/connect_us.html">联系我们</a>
            <a href="../other/map.html">网站地图</a>
            <span>© 2013 Black.com 版权所有</span>
        </footer>
  
    </body>
  
</html>
<!--TODO: table sort -->
<!--TODO: forbid multiple popover -->
<script> //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!temp
function checkOverflow(ele) {
    return (ele.prop('scrollWidth') > ele.innerWidth() || ele.text().indexOf('\n') >= 0)
}
function cellPosition(cellele) {
    return { row: cellele.closest('tr').prop('rowIndex'), col: cellele.closest('td').prop('cellIndex') };
}
function createArray(length) {
    var arr = new Array(length || 0),
    i = length;
    
    if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while(i--) arr[length - 1 - i] = createArray.apply(this, args);
    }
    return arr;
}
function textToHtml(text) {
    return text.replace(/\n/g, '<BR>');
}

function isInt(str) {
    return parseInt(str) == str;
    //return (str.length < 10 && /^[0-9]+$/.test(str));
}
function isBool(str) {
    var lowstr = str.toLowerCase();
    return (lowstr == 'true' || lowstr == 'false');
}
function isFloat(str) {
    return parseFloat(str) == str;
}
function isDateTime(str) {
    return /\d{2}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(str);
}
function inRange(num, low, high) {
    return (num >= low && num <= high);
}
function deepCopy(obj) {
    if($.isPlainObject(obj)) {
        return $.extend(true, {}, obj);
    } else if($.isArray(obj)) {
        return $.extend(true, {}, {0:obj})[0];
    } else
        return obj;
}
// for compatibility
function deepCopyArray(arr) {
    return $.extend(true, {}, {0:arr})[0];
}

</script>
<script> // page specified functions
function editable(col) {
    if(col == 0 || col == 7)
        return false;
    else
        return true;
}

function isRowValid(row) {
    /*var zeroCnt = 0;

    if(!isInt(row.find('td:eq(0)').text())) return false;
    for(var i = 1; i < 4; i++) {
        var coltxt = row.find('td:eq(' + i + ')').text();

        if(coltxt.length > 255) return false;
        if(coltxt.length == 0) zeroCnt++;
    }
    if(zeroCnt == 3) return false;*/
    return true;
}
function mapResult(res) {
    /*return $.map(res, function(ele) {
        return [[ele[0], ele[1], ele[3], ele[2]]];
    });*/
    return res;
}
var rowtmpl = 
    ' \
    <tr> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td class="cell" style="padding:0"></td> \
        <td><div> \
            <button class="btn btn-icon"><i class="icon-ok"></i></button> \
            <button class="btn btn-icon"><i class="icon-remove"></i></button> \
            <button class="btn btn-icon"><i class="icon-repeat"></i></button> \
        </div></td> \
    </tr>';
    
var schema = [{id:'f_ID', name:['航班号']}, {id:'Airport', name:['起飞机场', '到达机场']}, 
                {id:'Time', name:['起飞时间', '到达时间']}, {id:'AircraftType', name:['机型']}, 
                {id:'Schedule', name:['日程']}, {id:'Punctuality', name:['准点率']}, {id:'Stop', name:['中转']}, 
                {id:'Price', name:['报价', '机场税', '燃油税']}];
</script>

<script> // class ResultTable
var rt;
var manip = {
    mode: 'view',
    /*toDisplayObj: function(div) {
     *   return div.find('input').val();
},*/
    getData: function(div) {
        if(div.data('mode') == 'view') {
            var len = div.data('view_prefix') ? div.data('view_prefix').length : 0;
            return div.text().substring(len, div.text().length);
        }
        else return div.find('input').val();
    },
    edit: function(div, obj) {
        obj = (obj ? obj : this.getData(div));
        div.html('<input type="text" class="cell-content" value="' + this.getData(div) + '">');
        div.removeClass().addClass('cell-content').css('padding', 0);
        div.find('input').focus().select();
        div.data('mode', 'edit');
        return div;
    },
    view: function(div, obj) {
        obj = (obj ? obj : this.getData(div));
        var pos = cellPosition(div);
        div.removeClass().addClass('cell-content text-cropped').css('padding', '2%');
        if(schema[pos.col].name.length > 1) {
            var prefix = schema[pos.col].name[ResultTable.prototype.divIndex(div)[0]] + ': ';
            div.data('view_prefix', prefix);
            div.html(prefix);
            //console.log(schema[pos.col].name[ResultTable.prototype.divIndex(div)[0]]);
            //div.html('');
            div.append(obj);
        } else {
            div.html(obj);
        }
        //console.log(div.hasClass('text-cropped'));
        div.data('mode', 'view');
        return div;
    }
}

function ResultTable(data) {
    this.$table = $('#resultTable');
    this.$verbose = $('#resultVerbose');
    // callback
    this.defaultManipulator = manip;
    this.manipCallbackList = {};
    // model
    this.data = [schema].concat(mapResult(data));
    this.cache = deepCopy(this.data);
    this.overflow = createArray(data.length + 1, schema.length);
    // view
    this.updateContentView();
    this.updateResultVerbose();
}
ResultTable.prototype = {
    // callback related
    divIndex: function(div) {
        var indexMultiDim = [];
        while(div.prop('tagName') == 'DIV') {
            indexMultiDim.unshift(div.parent().children().index(div));
            div = div.parent();
        }
        return indexMultiDim;
    },
    
    manipFunc: function(indexMultiDim) { // get manip function by col and key
        var func;
        while(indexMultiDim.length && !(func = this.manipCallbackList[JSON.stringify(indexMultiDim)])) {
            indexMultiDim = indexMultiDim.pop();
        }
        return (func ? func : this.defaultManipulator);
    },
    
    addManipFunc: function(indexMultiDim, func) {
        this.manipCallbackList[JSON.stringify(indexMultiDim)] = func;
    },
    
    getRow: function(row) {
        return this.$table.find('tr:eq(' + row + ')');
    },
    
    getRowCnt: function() {
        return this.$table.find('tr').length;
    },
    
    getCell: function(row, col) {
        if(typeof row == 'number')
            return this.$table.find('tr:eq(' + row + ') td:eq(' + col + ')');
        else
            return row.find('td:eq(' + col + ')');
    },
    
    pushRow: function(rowData) { //TODO: animation
        // model
        this.overflow.push(new Array(schema.length));
        this.cache.push(deepCopy(rowData));
        this.data.push(deepCopy(rowData));
        // view
        this.$table.find('tbody').append(rowtmpl);
        this.updateRowView(this.getRowCnt() - 1);
        this.updateResultVerbose();
    },
    
    /*pushRow: function(rowData) {
        this.insertRow(rowData, this.getRowCnt().length);
    },*/
    
    removeRow: function(rowid) { //TODO: animation
        // model
        //TODO: use lazy removal to speedup
        this.overflow.splice(rowid, 1);
        this.cache.splice(rowid, 1);
        this.data.splice(rowid, 1);
        // view
        this.getRow(rowid).remove(); //TODO: any uncleaned data? popover events?
        this.updateResultVerbose();
    },
    
    popRow: function() {
        this.removeRow(this.getRowCnt() - 1);
    },
    
    resetRow: function(rowId) {
        // model
        this.cache[rowId] = deepCopy(this.data[rowId]);
        // view
        this.updateRowView(rowId);
        this.getRow(rowId).removeClass();
    },
    
    commitRow: function(rowId) { // write from buffer to data
        // model
        this.data[rowId] = deepCopy(this.cache[rowId]);
        // view
        var row = this.getRow(rowId);
        row.removeClass().addClass('success');
        setTimeout(function() { row.removeClass(); }, 3000);
    },
    
    updateResultVerbose: function() {
        this.$verbose.html('共有' + (this.getRowCnt() - 1) + '个搜索结果');
    },

    updateRowView: function(rowId) {
        for(var colId = 0; colId < schema.length; colId++) {
            this.setCell(this.getCell(rowId, colId), this.cache[rowId][colId]);
        }
    },
    
    updateContentView: function() {
        var curRowCnt = this.getRowCnt();

        var minRowCnt = Math.min(curRowCnt, this.data.length);
        // skip header
        for(var rowId = 1; rowId < minRowCnt; rowId++) {
            this.updateRowView(rowId);
        }
        if(curRowCnt > this.data.length) {
            for(var t = curRowCnt - this.data.length; t--; ) {
                this.$table.find('tr:last').remove();
            }
        } else if(curRowCnt < this.data.length) {
            for(var t = curRowCnt; t < this.data.length; t++) {
                this.$table.find('tbody').append(rowtmpl);
                this.updateRowView(t);
            }
        }
    },
    
    addPopover: function(param1, param2) {
        var obj;
        if(typeof param1 == 'number') { // row col
            obj = $($(this.$table.children()[param1]).children()[param2]);
        } else { // obj
            obj = param1;
        }
        
        //TODO: maybe not textarea
        var edit = false;
        var edittmpl = '<div><textarea style="height:100px">__texthere__</textarea></div>'
            + '<div style="text-align:center;"><button class="btn btn-primary">保存</button>'
            + '<button class="btn">放弃</button></div>';
        var viewtmpl = '<div style="word-wrap:break-word;">__texthere__</div>'
            + '<div style="font-size:8px;line-height:8px;color:#C0C0C0;text-align:right;">click to edit</div>'
        
        obj.popoverex({
            trigger: 'hover', 
            hoverReserve: "in in_popover",
            delay: {show: 100, hide: 1000},
            placement: 'bottom',
            html: true,
            container: 'body',
            content: function() {
                return viewtmpl.replace('__texthere__', textToHtml($(this).text()));
            },
            popover_click: function(e) {
                if(!edit && $(e.target).prop('tagName') == 'DIV') {
                    edit = true;
                    
                    var ele = e.data.ele, pop = e.data.pop;
                    var popcontent = pop.find('[class=popover-content]');
                    ele.popoverex('pin');
                    popcontent.html(edittmpl.replace('__texthere__', ele.text())); //text()));
                    var textarea = popcontent.find('textarea');
                    textarea.focus().select();
                    
                    // register button events
                    var buttons = pop.find('button');
                    var close = function() {
                        buttons.each(function() {
                            $(this).off('click');
                        });
                        ele.popoverex('unpin');
                        ele.popoverex('hide');
                        edit = false;
                    };
                    $(buttons[0]).click(function() {
                        close();
                        rt.modifyDiv(ele, textarea.val())
                    });
                    $(buttons[1]).click(close);
                }
            },
        });
    },
    
    setDiv: function(div, obj) {
        var pos = cellPosition(div);
        var index = this.divIndex(div), strindex = JSON.stringify(index);
        this.manipFunc(index).view(div, obj);
        // popover
        var divOverflow = checkOverflow(div);
        if(!this.overflow[pos.row][pos.col])
            this.overflow[pos.row][pos.col] = {};
        if(!this.overflow[pos.row][pos.col][strindex] && divOverflow)  {
            this.overflow[pos.row][pos.col][strindex] = true;
            this.addPopover(div);
        } else if(this.overflow[pos.row][pos.col][strindex] && !divOverflow) {
            this.overflow[pos.row][pos.col][strindex] = false;
            div.popoverex('destroy');
        }
        this.cache[pos.row][pos.col][strindex] = deepCopy(obj);
    },
    
    modifyDiv: function(div, obj) {
        var pos = cellPosition(div);
        obj = obj ? obj : this.manipFunc(this.divIndex(div)).getData(div);
        if(this.cache[pos.row][pos.col][this.divIndex(div)] != obj) {
            this.setDiv(div, obj);
            if(isRowValid(this.getRow(pos.row))) {
                div.closest('tr').removeClass().addClass('warning');
            } else {
                div.closest('tr').removeClass().addClass('error');
            }
        } else {
            var manip = this.manipFunc(this.divIndex(div));
            manip.view(div, obj);
        }
    },
    
    setCell: function(cell, obj) { // with no checks, only one dim array supported
        var pos = cellPosition(cell);
        
        var cnt = 0;
        for(var index in obj) {
            var div;
            if(cnt < cell.children().length) {
                div = $(cell.children()[cnt]);
            } else {
                div = $('<div></div>');
                cell.append(div);
            }
            this.setDiv(div, obj[index]);
            cnt++;
        }
        //TODO: how to clear if number of div changes
        // one dim only
        /*for(var i = cell.children().length - 1; i >= obj.length; i--) {
            if(this.overflow[pos.row][pos.col]['[' + i + ']']) {
                $(cell.children()[i]).popoverex('destroy');
            }
            this.overflow[pos.row][pos.col]['[' + i + ']'] = undefined;
        }*/
        
    }, 
}
rt = new ResultTable([[[1],[3,2],[2,3],[4],[5],[6],[7],[8,9,10]]]);
</script>

<script> //event handlers
$('#resultTable').click(function(e) {
    //console.log($(e.target).prop('tagName'));
    switch($(e.target).prop('tagName')) {
    case 'DIV' : {
        var pos = cellPosition($(e.target));
        var div = $(e.target);
        console.log(rt.divIndex(div));
        if(!editable(pos.col) || rt.overflow[pos.row][pos.col][JSON.stringify(rt.divIndex(div))]) return;
                           
        rt.manipFunc(rt.divIndex(div)).edit(div);
        break;
    }
    case 'I':
        if($(e.target).parent().prop('tagName') != 'BUTTON')
            break;
    case 'BUTTON': {
        //TODO: enable and disable of buttons
        var btn = $(e.target).closest('button');
        var rowId = btn.closest('tr').prop('rowIndex');
        switch(btn.parent().children().index(btn)) {
        case 0: { // submit
            $.getJSON(
                '/manage/hotel/async',
                {
                    h_id: rt.cache[rowId][0],
                    name: rt.cache[rowId][1],
                    location: rt.cache[rowId][2],
                    description: rt.cache[rowId][3],
                    type: 'update',
                },
                function(data) {
                    console.log(data);
                    if(data.status == 'succeeded')
                        rt.commitRow(rowId);
                    else
                        alert('Submit failed');
                });
            break;
        }
        case 1: { // remove
            $.getJSON(
                '/manage/hotel/async',
                {
                    h_id: rt.cache[rowId][0],
                    type: 'delete',
                },
                function(data) {
                    console.log(data);
                    rt.removeRow(rowId);
                });
            break;
        }
        case 2: { // reset
            rt.resetRow(rowId);
            break;
        }
        }
    }
    }
});
    
$('#resultTable').focusout(function(e){
    var text = $(e.target).val();
    var div = $(e.target).closest('div');
    if(editable(cellPosition(div).col)) {
        //rt.manipFunc(rt.divIndex(div)).toDisplayObj(div);
        rt.modifyDiv(div);
    }
});
            
$('#bsSearch').click(function(e) {
    $.getJSON(
        '/manage/hotel/async',
        {
            h_id: $('#bsHID').val(),
            name: $('#bsName').val(),
            location: $('#bsLocation').val(),
            type: 'search',
        },
        function(data) {
            rt = new ResultTable(data.hotel);
        });
});

$('#atAdd').click(function(e) {
    var row = $('#addTable tr:first');
    var addobj = {
        h_id: '',
        name: row.find('td:eq(1) input:first').val(),
        location: row.find('td:eq(2) input:first').val(),
        description: row.find('td:eq(3) input:first').val(),
        type: 'add',
    };
    $.getJSON(
        '/manage/hotel/async',
        addobj,
        function(data) {
            console.log(data);
            if(data.status == 'succeeded') {
                $('#addTable input').val('');
                rt.pushRow([data.h_id, addobj.name, addobj.location, addobj.description]);
            }
            else
                alert('Add failed');
        });
});
$('#atRemove').click(function(e) {
    $('#addTable input').val('');
});
</script>
